<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Chat</title>
    <link rel="shortcut icon" href="./public/img/logo.png" type="image/x-icon">
    <link rel="stylesheet" href="./public/css/bootstrap.min.css">
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            display: flow-root;
        }

        #App {
            width: 100%;
            height: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
        }

        .container-main {
            width: 100%;
            height: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;

        }

        .sidebar {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
        }

        .user-info {
            display: flex;
            white-space: nowrap;
        }

        .edit-info {
            font-size: 16px;
            width: 100%;
            flex: 0 1 140px;
            box-sizing: border-box;
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid black;
        }

        .edit-info:focus-visible {
            outline: none;
        }

        .main {
            flex: 1 1 auto;
            padding: 16px;
            box-sizing: border-box;
        }

        .chat-box {
            height: 70%;
            width: 100%;
            overflow: auto;
        }

        /* .chat {
            width: 100%;
            display: flex;
            margin-bottom: 48px;
        } */

        .name {
            flex: 0 0 auto;
            max-width: 64px;
        }

        .content {
            /* border: 1px solid black; */
            box-sizing: border-box;
            word-break: break-all;
        }

        .edit-box {
            height: 30%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .edit {
            flex: 0 1 100%;


        }
    </style>
</head>

<body>
    <template id="index-main">
        <div class="container-main">
            <div class="sidebar border-end border-secondary-subtle">
                <div class="flex-fill h-100">
                    <div class="user-info">
                        <span>名称：</span>
                        <span>{{ info.nickname }}</span>
                    </div>
                    <div style="margin: 16px 0;"></div>
                    <div class="p-2" @click="onSelect(item.userId)" :style="selectStyle(item.userId)"
                        style="margin-top: 4px; cursor:pointer;" v-for="item in friendListComputed" :key="item.userId">
                        <span>{{ item.nickname }}</span>
                        <span class="float-end" style="color: green;" v-show="item.isOnline">在线</span>
                        <span class="float-end" style="color: gray;" v-show="!item.isOnline">离线</span>
                    </div>
                </div>
                <div style="height: 48px;" class="flex-shrink-0 flex-grow-0">
                    <button @click="onOpenSetting" class="btn btn-primary" type="button">设置</button>
                    <button @click="onExit" class="btn btn-danger ms-2" type="button">退出</button>
                </div>
            </div>

            <div @click="visibleSetting = false" :class="{ show: visibleSetting }"
                :style="{display: visibleSetting ? 'block' : 'none'}" class="modal fade" id="exampleModal" tabindex="-1"
                aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div @click.stop class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="exampleModalLabel">设置</h1>
                            <button @click="visibleSetting = false" type="button" class="btn-close"
                                data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label for="recipient-name" class="col-form-label">昵称:</label>
                                    <input v-model="editInfo.nickname" type="text" class="form-control"
                                        id="recipient-name">
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button @click="visibleSetting = false" type="button" class="btn btn-secondary"
                                data-bs-dismiss="modal">Close</button>
                            <button @click="onEditSubmit" type="button" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="!isSelectChat" class="main">
                <h1>Welcome</h1>
            </div>
            <div v-else class="main">
                <div ref="chatBoxElement" :style="{scrollBehavior: scrollSmooth ? 'smooth' : 'auto'}" class="chat-box">
                    <div :style="{direction: item.user_id !== info.userId ? 'ltr' : 'rtl', minHeight: '64px'}"
                        v-for="item in chatListComputed" :key="item.id" class="p-3 mb-4 d-flex">
                        <div class="name">{{ item.nickname }}</div>
                        <div :style="{direction: 'ltr', [item.user_id !== info.userId ? 'marginLeft' : 'marginRight']: '32px', [item.user_id !== info.userId ? 'marginRight' : 'marginLeft']: '90px' }"
                            class="content p-2 rounded" :class="contentClass(item.user_id)">
                            {{ item.content }}
                        </div>
                    </div>
                </div>
                <div class="edit-box border-top border-secondary-subtle">
                    <div class="d-flex p-2">
                        <button @click="onResetMessage" type="button"
                            class="btn btn-outline-warning ms-auto">重置</button>
                        <button @click="onSendMessage" type="button"
                            class="btn btn-outline-primary me-0 ms-2">发送</button>
                    </div>
                    <div class="form-floating flex-grow-0 flex-fill h-100">
                        <textarea @keydown.enter.prevent="onSendMessage" v-model="content" class="form-control h-100"
                            placeholder="Leave a comment here" id="floatingTextarea"></textarea>
                        <label for="floatingTextarea">Input...</label>
                    </div>
                </div>
            </div>
        </div>
    </template>


    <div id="App">
        <div v-if="loading">Loading...</div>
        <index-main v-if="!loading" />
    </div>
</body>
<script type="module">
    import Vue from './public/js/vue.esm.js'
    import { useAuthMiddleware } from './middleware/auth.js'
    import IndexMain from './components/IndexMain.js'

    new Vue({
        el: '#App',
        components: {
            IndexMain,
        },
        setup() {
            const { loading } = useAuthMiddleware()
            return {
                loading
            }
        },
    })

    // const ws = new WebSocket('ws://localhost:20001/ws')
    // ws.onopen = function () {
    //     ws.send(JSON.stringify({
    //         type: 0,
    //         data: {
    //             token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXlsb2FkIjp7ImlkIjoxfSwiZXhwIjoxNjcyOTMxNzEzMjc5LCJpYXQiOjE2NzI5MzE3MTN9.ku3FksuhMnD-WdZtKlL0-1_t1LisB8t1roW9TKKn8hM'
    //         }
    //     }))
    // }
</script>

</html>