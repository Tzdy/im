<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Chat</title>
    <link rel="stylesheet" href="./public/css/bootstrap.min.css">
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        html,
        body {
            height: 100%;
            width: 100%;
            display: flow-root;
        }

        #App {
            width: 100%;
            height: 100%;
            margin: 0 auto;
            box-sizing: border-box;
            display: flex;
        }

        .sidebar {
            flex: 0 0 250px;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
        }

        .user-info {
            display: flex;
            white-space: nowrap;
        }

        .edit-info {
            font-size: 16px;
            width: 100%;
            flex: 0 1 140px;
            box-sizing: border-box;
            border-top: none;
            border-left: none;
            border-right: none;
            border-bottom: 1px solid black;
        }

        .edit-info:focus-visible {
            outline: none;
        }

        .main {
            flex: 1 1 auto;
            padding: 16px;
            box-sizing: border-box;
        }

        .chat-box {
            height: 70%;
            width: 100%;
            overflow: auto;
        }

        /* .chat {
            width: 100%;
            display: flex;
            margin-bottom: 48px;
        } */

        .name {
            flex: 0 0 auto;
            max-width: 64px;
        }

        .content {
            /* border: 1px solid black; */
            box-sizing: border-box;
            word-break: break-all;
        }

        .edit-box {
            height: 30%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .edit {
            flex: 0 1 100%;


        }
    </style>
</head>

<body>
    <div id="App">
        <div class="sidebar border-end border-secondary-subtle">
            <div class="flex-fill h-100">
                <div class="user-info">
                    <span>名称：</span>
                    <span>{{ info.nickname }}</span>
                </div>
                <div style="margin: 16px 0;"></div>
                <div @click="onSelect(item.id)" :style="selectStyle(item.id)" style="margin-top: 4px; cursor:pointer;"
                    v-for="item in friendList" :key="item.id">
                    <span>{{ item.nickname }}</span>
                    <span v-show="item.id === info.id">(我自己)</span>
                    <span style="color: green;" v-show="item.isOnline">在线</span>
                    <span style="color: gray;" v-show="!item.isOnline">离线</span>
                </div>
            </div>
            <div style="height: 48px;" class="flex-shrink-0 flex-grow-0">
                <button @click="onOpenSetting" class="btn btn-primary" type="button">设置</button>
                <button class="btn btn-danger ms-2" type="button">退出</button>
            </div>
        </div>

        <div @click="visibleSetting = false" :class="{ show: visibleSetting }"
            :style="{display: visibleSetting ? 'block' : 'none'}" class="modal fade" id="exampleModal" tabindex="-1"
            aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div @click.stop class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">设置</h1>
                        <button @click="visibleSetting = false" type="button" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label">姓名:</label>
                                <input v-model="editInfo.nickname" type="text" class="form-control" id="recipient-name">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button @click="visibleSetting = false" type="button" class="btn btn-secondary"
                            data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Submit</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="!isSelectChat" class="main">
            <h1>Welcome</h1>
        </div>
        <div v-else class="main">
            <div ref="chatBoxElement" style="scroll-behavior: smooth;" class="chat-box">
                <div :style="{direction: item.user_id !== info.id ? 'ltr' : 'rtl', minHeight: '64px'}"
                    v-for="item in chatListComputed" :key="item.id" class="p-3 mb-4 d-flex">
                    <div class="name">{{ item.nickname }}</div>
                    <div :style="{direction: 'ltr', [item.user_id !== info.id ? 'marginLeft' : 'marginRight']: '32px', [item.user_id !== info.id ? 'marginRight' : 'marginLeft']: '90px' }"
                        class="content p-2 rounded" :class="contentClass(item.user_id)">
                        {{ item.content }}
                    </div>
                </div>
            </div>
            <div class="edit-box border-top border-secondary-subtle">
                <div class="d-flex p-2">
                    <button @click="onResetMessage" type="button" class="btn btn-outline-warning ms-auto">重置</button>
                    <button @click="onSendMessage" type="button" class="btn btn-outline-primary me-0 ms-2">发送</button>
                </div>
                <div class="form-floating flex-grow-0 flex-fill h-100">
                    <textarea @keydown.enter="onSendMessage" v-model="content" class="form-control h-100"
                        placeholder="Leave a comment here" id="floatingTextarea"></textarea>
                    <label for="floatingTextarea">Input...</label>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="module">
    import Vue from './public/js/vue.esm.js'
    import { ref, computed, reactive, nextTick } from './public/js/vue.esm.js'
    const vm = new Vue({
        el: '#App',
        setup() {
            const info = reactive({
                id: 3,
                nickname: '岳冬阳'
            })
            const editInfo = reactive({
                nickname: ''
            })
            const friendList = ref([
                {
                    nickname: '路人甲',
                    id: 1,
                    isOnline: false,
                },
                {
                    nickname: '路人乙',
                    id: 2,
                    isOnline: true,
                },
                {
                    nickname: '岳冬阳',
                    id: 3,
                    isOnline: true,
                }
            ])

            const nicknameMap = computed(() => {
                friendList.value.reduce((a, b) => {
                    a[b.id] = b.nickname
                    return a
                }, {})
            })

            const chatList = ref([
                {
                    "id": 1,
                    "user_id": 3,
                    "friend_id": 2,
                    "content": "你好啊",
                    "created_time": "2023-01-06T12:48:31.000Z"
                },
                {
                    "id": 2,
                    "user_id": 3,
                    "friend_id": 2,
                    "content": "在不在？？？？？",
                    "created_time": "2023-01-06T12:48:31.000Z"
                },
                {
                    "id": 3,
                    "user_id": 2,
                    "friend_id": 3,
                    "content": "有毒吧？？？",
                    "created_time": "2023-01-06T12:48:31.000Z"
                }
            ])

            const content = ref('')
            const chatBoxElement = ref(null) // Element

            function onSendMessage() {
                chatList.value.push({
                    id: 4,
                    user_id: info.id,
                    friend_id: selectUserId.value,
                    content: content.value,
                    "created_time": "2023-01-06T12:48:31.000Z",
                })
                content.value = ''
                nextTick(() => {
                    chatBoxElement.value.scrollTop = Number.MAX_SAFE_INTEGER
                })
            }

            function onResetMessage() {
                content.value = ''
            }

            function receiveMessage() {
                chatList.value.push({
                    id: 4,
                    user_id: selectUserId.value,
                    friend_id: info.id,
                    content: "你是不是有？？？？",
                    "created_time": "2023-01-06T12:48:31.000Z",
                })
            }

            const selectUserId = ref(null)
            const isSelectChat = computed(() => {
                return selectUserId.value !== null
            })

            const contentClass = function (userId) {
                return {
                    'bg-info': userId === info.id,
                    'bg-body-secondary': userId !== info.id,
                    'text-light': userId === info.id,
                    'text-black': userId !== info.id,
                }
            }

            const visibleSetting = ref(false)
            function onOpenSetting() {
                editInfo.nickname = info.nickname
                visibleSetting.value = true
            }


            return {
                info,
                editInfo,
                friendList,
                chatList,
                selectUserId,
                contentClass,
                visibleSetting,
                onOpenSetting,

                content,
                chatBoxElement,
                onSendMessage,
                onResetMessage,
            }
        },
        computed: {
            isSelectChat() {
                return this.selectUserId !== null
            },

            nicknameMap() {
                return this.friendList.reduce((a, b) => {
                    a[b.id] = b.nickname
                    return a
                }, {})
            },

            chatListComputed() {
                return this.chatList.map(item => ({
                    nickname: this.nicknameMap[item.user_id],
                    ...item,
                }))
            }
        },
        methods: {
            selectStyle(id) {
                if (this.selectUserId === id) {
                    return {
                        backgroundColor: 'rgba(208,215,222,.32)'
                    }
                }
                return {}
            },
            onSelect(id) {
                console.log(id)
                this.selectUserId = id
            }
        }
    })

    // const ws = new WebSocket('ws://localhost:20001/ws')
    // ws.onopen = function () {
    //     ws.send(JSON.stringify({
    //         type: 0,
    //         data: {
    //             token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJwYXlsb2FkIjp7ImlkIjoxfSwiZXhwIjoxNjcyOTMxNzEzMjc5LCJpYXQiOjE2NzI5MzE3MTN9.ku3FksuhMnD-WdZtKlL0-1_t1LisB8t1roW9TKKn8hM'
    //         }
    //     }))
    // }
</script>

</html>